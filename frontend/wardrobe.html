<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStyle AI - Wardrobe Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .upload-area.active {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-area p {
            color: #666;
            font-size: 14px;
        }

        #imagePreview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-top: 20px;
            display: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Form Section */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            grid-column: 1 / -1;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Items Grid */
        .items-section {
            grid-column: 1 / -1;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .item-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .item-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .item-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-delete {
            flex: 1;
            padding: 6px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üëî SmartStyle AI - Wardrobe Manager</h1>
            <p>Upload images and let AI auto-detect clothing details</p>
        </div>

        <div class="main-content">
            <!-- STEP 1: Upload Image -->
            <div class="section">
                <h2>
                    <span class="step-number">1</span>
                    Upload Image
                </h2>

                <div id="message" class="message"></div>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∏</div>
                    <p><strong>Click to upload</strong> or drag and drop</p>
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">
                        PNG, JPG, GIF up to 10MB
                    </p>
                    <input type="file" id="imageInput" accept="image/*">
                </div>

                <img id="imagePreview" alt="Preview">

                <div class="loading" id="loading">
                    <span class="spinner"></span>Analyzing with AI...
                </div>
            </div>

            <!-- STEP 2: Review & Edit Details -->
            <div class="section">
                <h2>
                    <span class="step-number">2</span>
                    Review & Edit
                </h2>

                <form id="detailsForm">
                    <div class="form-grid">
                        <div class="form-group full">
                            <label>Item Name <span class="required">*</span></label>
                            <input type="text" id="itemName" required placeholder="e.g., Green Floral Shirt">
                        </div>

                        <div class="form-group">
                            <label>Category <span class="required">*</span></label>
                            <select id="category" required>
                                <option value="">Select Category</option>
                                <option value="Tops">Tops</option>
                                <option value="Bottoms">Bottoms</option>
                                <option value="Dresses">Dresses</option>
                                <option value="Outerwear">Outerwear</option>
                                <option value="Footwear">Footwear</option>
                                <option value="Accessories">Accessories</option>
                                <option value="Indian Traditional">Indian Traditional</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Sub-Category / Type <span class="required">*</span></label>
                            <input type="text" id="subcategory" required placeholder="e.g., Shirt, Jeans, Anarkali">
                        </div>

                        <div class="form-group">
                            <label>Fabric / Material <span class="required">*</span></label>
                            <input type="text" id="fabric" required placeholder="e.g., Cotton, Silk, Denim">
                        </div>

                        <div class="form-group">
                            <label>Color <span class="required">*</span></label>
                            <input type="text" id="color" required placeholder="e.g., Light Green, Navy Blue">
                        </div>

                        <div class="form-group">
                            <label>Pattern <span class="required">*</span></label>
                            <input type="text" id="pattern" required placeholder="e.g., Solid, Floral, Striped">
                        </div>

                        <div class="form-group">
                            <label>Style <span class="required">*</span></label>
                            <input type="text" id="style" required placeholder="e.g., Casual, Formal, Ethnic">
                        </div>

                        <div class="form-group">
                            <label>Season <span class="required">*</span></label>
                            <select id="season" required>
                                <option value="">Select Season</option>
                                <option value="Spring">Spring</option>
                                <option value="Summer">Summer</option>
                                <option value="Fall">Fall</option>
                                <option value="Winter">Winter</option>
                                <option value="All-Season">All-Season</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Gender <span class="required">*</span></label>
                            <select id="gender" required>
                                <option value="">Select Gender</option>
                                <option value="male">üë® Male</option>
                                <option value="female">üë© Female</option>
                                <option value="unisex">Unisex</option>
                            </select>
                        </div>
                                                <div class="form-group">
                            <label>Occasions (Optional)</label>
                            <input type="text" id="occasions" placeholder="e.g., casual, party, work" value="casual">
                        </div>


                        <div class="form-group">
                            <label>Brand (Optional)</label>
                            <input type="text" id="brand" placeholder="e.g., Nike, Zara">
                        </div>

                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">‚úÖ Save to Wardrobe</button>
                            <button type="reset" class="btn btn-secondary">Clear Form</button>
                        </div>
                    </div>
                </form>
            </div>
            

            <!-- STEP 3: Wardrobe Items -->
            <div class="section items-section">
                <h2>
                    <span class="step-number">3</span>
                    Your Wardrobe
                </h2>

                <div id="itemsGrid" class="items-grid">
                    <div class="empty-state">üì¶ No items yet. Upload your first item!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/wardrobe';
        let currentFile = null;

        // ========================================
        // UPLOAD IMAGE
        // ========================================

        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const loading = document.getElementById('loading');
        const messageDiv = document.getElementById('message');

        // Click to upload
        uploadArea.addEventListener('click', () => imageInput.click());

        // File selected
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('active');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('active');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        });

        // ========================================
        // HANDLE IMAGE FILE
        // ========================================

        async function handleImageFile(file) {
            currentFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Send to backend for analysis
            await analyzeImage(file);
        }

        // ========================================
        // ANALYZE IMAGE WITH AI
        // ========================================

        async function analyzeImage(file) {
            loading.style.display = 'block';
            messageDiv.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', file);

                console.log('üì§ Uploading image for analysis...');

                const response = await fetch(`${API_URL}/analyze-image`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }

                const data = await response.json();
                console.log('‚úÖ Analysis result:', data);

                // AUTO-FILL FORM FIELDS WITH AI ANALYSIS
                fillFormWithAnalysis(data);

                showMessage('‚úÖ Image analyzed! Review and edit details below.', 'success');

            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                showMessage(`‚ùå ${error.message}`, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        // ========================================
// FILL FORM WITH AI ANALYSIS
// ========================================

function fillFormWithAnalysis(data) {
    console.log('üìù Auto-filling form with:', data);

    // Basic text fields
    document.getElementById('itemName').value = data.itemname || '';
    document.getElementById('category').value = data.category || 'Tops';
    document.getElementById('subcategory').value = data.subcategory || '';
    document.getElementById('fabric').value = data.fabric || '';
    document.getElementById('color').value = data.color || '';
    document.getElementById('pattern').value = data.pattern || '';
    document.getElementById('style').value = data.style || '';
    
    // ‚úÖ FIX SEASON DROPDOWN - Normalize values
    const seasonMap = {
        'spring': 'Spring',
        'summer': 'Summer',
        'fall': 'Fall',
        'winter': 'Winter',
        'all-season': 'All-Season',
        'Spring': 'Spring',
        'Summer': 'Summer',
        'Fall': 'Fall',
        'Winter': 'Winter',
        'All-Season': 'All-Season'
    };
    const seasonValue = data.season || 'Summer';
    const normalizedSeason = seasonMap[seasonValue] || 'Summer';
    document.getElementById('season').value = normalizedSeason;
    console.log(`Season: ${data.season} ‚Üí ${normalizedSeason}`);
    
    // ‚úÖ FIX GENDER DROPDOWN - Normalize values
    const genderMap = {
        'male': 'male',
        'female': 'female',
        'unisex': 'unisex',
        'Male': 'male',
        'Female': 'female',
        'Unisex': 'unisex'
    };
    const genderValue = data.gender || 'female';
    const normalizedGender = genderMap[genderValue] || 'female';
    document.getElementById('gender').value = normalizedGender;
    console.log(`Gender: ${data.gender} ‚Üí ${normalizedGender}`);
    
    // ‚úÖ FILL OCCASIONS (array)
    if (data.occasions && Array.isArray(data.occasions)) {
        const occasionsStr = data.occasions.join(', ');
        document.getElementById('occasions').value = occasionsStr;
        console.log(`Occasions: ${occasionsStr}`);
    } else {
        document.getElementById('occasions').value = 'casual';
    }

    // Scroll to form
    document.getElementById('detailsForm').scrollIntoView({ behavior: 'smooth' });

    console.log('‚úÖ Form filled!');
}


        // ========================================
        // SAVE ITEM TO WARDROBE
        // ========================================

                document.getElementById('detailsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                // Parse occasions (from comma-separated string to array)
                const occasionsStr = document.getElementById('occasions').value || 'casual';
                const occasions = occasionsStr.split(',').map(o => o.trim()).filter(o => o);

                const itemData = {
                    name: document.getElementById('itemName').value,
                    category: document.getElementById('category').value,
                    subcategory: document.getElementById('subcategory').value,
                    fabric: document.getElementById('fabric').value,
                    color: document.getElementById('color').value,
                    pattern: document.getElementById('pattern').value,
                    style: document.getElementById('style').value,
                    season: document.getElementById('season').value,
                    gender: document.getElementById('gender').value,
                    occasions: occasions,
                    brand: document.getElementById('brand').value || ''
                };


                console.log('üíæ Saving item:', itemData);

                const response = await fetch(`${API_URL}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Save failed');
                }

                const result = await response.json();
                console.log('‚úÖ Item saved:', result);

                showMessage('‚úÖ Item saved to wardrobe!', 'success');

                // Reset form
                document.getElementById('detailsForm').reset();
                imagePreview.style.display = 'none';

                // Refresh items
                loadItems();

            } catch (error) {
                console.error('‚ùå Save error:', error);
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        });

        // ========================================
        // LOAD ALL ITEMS
        // ========================================

        async function loadItems() {
            try {
                console.log('üì¶ Loading items...');

                const response = await fetch(`${API_URL}/items`);

                if (!response.ok) throw new Error('Failed to load items');

                const items = await response.json();
                console.log('‚úÖ Items loaded:', items);

                const grid = document.getElementById('itemsGrid');

                if (items.length === 0) {
                    grid.innerHTML = '<div class="empty-state">üì¶ No items yet. Upload your first item!</div>';
                    return;
                }

                grid.innerHTML = items.map(item => `
                    <div class="item-card">
                        <div class="item-emoji">üëï</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">
                            <div>${item.color}</div>
                            <div>${item.category}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Load error:', error);
            }
        }

        // ========================================
        // DELETE ITEM
        // ========================================

        async function deleteItem(id) {
            if (!confirm('Delete this item?')) return;

            try {
                const response = await fetch(`${API_URL}/items/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Delete failed');

                showMessage('‚úÖ Item deleted!', 'success');
                loadItems();

            } catch (error) {
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        // ========================================
        // SHOW MESSAGE
        // ========================================

        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // ========================================
        // INIT
        // ========================================

        loadItems();
    </script>
</body>
</html>
